package org.apache.seatunnel.engine.client;

import org.apache.seatunnel.shade.com.fasterxml.jackson.core.JsonProcessingException;
import org.apache.seatunnel.shade.com.fasterxml.jackson.databind.JsonNode;
import org.apache.seatunnel.shade.com.fasterxml.jackson.databind.ObjectMapper;

import java.util.List;
import java.util.Map;
import java.util.Spliterators;
import java.util.stream.Collectors;
import java.util.stream.StreamSupport;

public class t {
    public static void main(String[] args) throws JsonProcessingException {
        String text =
                "{\"SinkWriteQPS#fake.public.table2\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"100000\",\"pipelineId\":\"2\"},\"metric\":\"SinkWriteQPS#fake.public.table2\",\"value\":23.059185242121444,\"timestamp\":1724312895572}],\"SourceReceivedBytes#fake.table1\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"40000\",\"pipelineId\":\"1\"},\"metric\":\"SourceReceivedBytes#fake.table1\",\"value\":180,\"timestamp\":1724312895572}],\"SinkWriteCount#fake.public.table2\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"100000\",\"pipelineId\":\"2\"},\"metric\":\"SinkWriteCount#fake.public.table2\",\"value\":30,\"timestamp\":1724312895572}],\"SinkWriteBytesPerSeconds#fake.public.table2\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"100000\",\"pipelineId\":\"2\"},\"metric\":\"SinkWriteBytesPerSeconds#fake.public.table2\",\"value\":299.53917050691246,\"timestamp\":1724312895572}],\"SourceReceivedCount#fake.table1\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"40000\",\"pipelineId\":\"1\"},\"metric\":\"SourceReceivedCount#fake.table1\",\"value\":20,\"timestamp\":1724312895572}],\"SinkWriteBytesPerSeconds\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"50000\",\"pipelineId\":\"1\"},\"metric\":\"SinkWriteBytesPerSeconds\",\"value\":134.52914798206277,\"timestamp\":1724312895572},{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"100000\",\"pipelineId\":\"2\"},\"metric\":\"SinkWriteBytesPerSeconds\",\"value\":299.53917050691246,\"timestamp\":1724312895572}],\"SinkWriteBytes#fake.table1\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"50000\",\"pipelineId\":\"1\"},\"metric\":\"SinkWriteBytes#fake.table1\",\"value\":180,\"timestamp\":1724312895572}],\"SourceReceivedBytes\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"40000\",\"pipelineId\":\"1\"},\"metric\":\"SourceReceivedBytes\",\"value\":180,\"timestamp\":1724312895572},{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"90000\",\"pipelineId\":\"2\"},\"metric\":\"SourceReceivedBytes\",\"value\":390,\"timestamp\":1724312895572}],\"SinkWriteCount#fake.table1\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"50000\",\"pipelineId\":\"1\"},\"metric\":\"SinkWriteCount#fake.table1\",\"value\":20,\"timestamp\":1724312895572}],\"SourceReceivedCount\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"40000\",\"pipelineId\":\"1\"},\"metric\":\"SourceReceivedCount\",\"value\":20,\"timestamp\":1724312895572},{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"90000\",\"pipelineId\":\"2\"},\"metric\":\"SourceReceivedCount\",\"value\":30,\"timestamp\":1724312895572}],\"SourceReceivedQPS#fake.table1\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"40000\",\"pipelineId\":\"1\"},\"metric\":\"SourceReceivedQPS#fake.table1\",\"value\":15.337423312883436,\"timestamp\":1724312895572}],\"SourceReceivedQPS#fake.public.table2\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"90000\",\"pipelineId\":\"2\"},\"metric\":\"SourceReceivedQPS#fake.public.table2\",\"value\":23.094688221709006,\"timestamp\":1724312895572}],\"SourceReceivedBytesPerSeconds#fake.public.table2\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"90000\",\"pipelineId\":\"2\"},\"metric\":\"SourceReceivedBytesPerSeconds#fake.public.table2\",\"value\":300.2309468822171,\"timestamp\":1724312895572}],\"SinkWriteBytesPerSeconds#fake.table1\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"50000\",\"pipelineId\":\"1\"},\"metric\":\"SinkWriteBytesPerSeconds#fake.table1\",\"value\":134.62976813762154,\"timestamp\":1724312895572}],\"SourceReceivedBytesPerSeconds#fake.table1\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"40000\",\"pipelineId\":\"1\"},\"metric\":\"SourceReceivedBytesPerSeconds#fake.table1\",\"value\":138.03680981595093,\"timestamp\":1724312895572}],\"SinkWriteCount\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"50000\",\"pipelineId\":\"1\"},\"metric\":\"SinkWriteCount\",\"value\":20,\"timestamp\":1724312895572},{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"100000\",\"pipelineId\":\"2\"},\"metric\":\"SinkWriteCount\",\"value\":30,\"timestamp\":1724312895572}],\"SinkWriteQPS\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"50000\",\"pipelineId\":\"1\"},\"metric\":\"SinkWriteQPS\",\"value\":14.9812734082397,\"timestamp\":1724312895572},{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"100000\",\"pipelineId\":\"2\"},\"metric\":\"SinkWriteQPS\",\"value\":23.059185242121444,\"timestamp\":1724312895572}],\"SinkWriteQPS#fake.table1\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"50000\",\"pipelineId\":\"1\"},\"metric\":\"SinkWriteQPS#fake.table1\",\"value\":14.992503748125937,\"timestamp\":1724312895572}],\"SourceReceivedCount#fake.public.table2\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"90000\",\"pipelineId\":\"2\"},\"metric\":\"SourceReceivedCount#fake.public.table2\",\"value\":30,\"timestamp\":1724312895572}],\"SinkWriteBytes#fake.public.table2\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"100000\",\"pipelineId\":\"2\"},\"metric\":\"SinkWriteBytes#fake.public.table2\",\"value\":390,\"timestamp\":1724312895572}],\"SourceReceivedBytesPerSeconds\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"40000\",\"pipelineId\":\"1\"},\"metric\":\"SourceReceivedBytesPerSeconds\",\"value\":138.03680981595093,\"timestamp\":1724312895572},{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"90000\",\"pipelineId\":\"2\"},\"metric\":\"SourceReceivedBytesPerSeconds\",\"value\":300.2309468822171,\"timestamp\":1724312895572}],\"SourceReceivedQPS\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"40000\",\"pipelineId\":\"1\"},\"metric\":\"SourceReceivedQPS\",\"value\":15.337423312883436,\"timestamp\":1724312895572},{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"90000\",\"pipelineId\":\"2\"},\"metric\":\"SourceReceivedQPS\",\"value\":23.094688221709006,\"timestamp\":1724312895572}],\"SinkWriteBytes\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"30000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=1, taskGroupId=30000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"50000\",\"pipelineId\":\"1\"},\"metric\":\"SinkWriteBytes\",\"value\":180,\"timestamp\":1724312895572},{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"TransformSeaTunnelTask\",\"taskID\":\"100000\",\"pipelineId\":\"2\"},\"metric\":\"SinkWriteBytes\",\"value\":390,\"timestamp\":1724312895572}],\"SourceReceivedBytes#fake.public.table2\":[{\"tags\":{\"jobId\":\"878908403454312449\",\"taskGroupId\":\"80000\",\"address\":\"[localhost]:5801\",\"service\":\"TaskExecutionService\",\"taskGroupLocation\":\"TaskGroupLocation{jobId=878908403454312449, pipelineId=2, taskGroupId=80000}\",\"member\":\"57527b3a-f58d-4257-976a-982595ce9739\",\"taskName\":\"SourceSeaTunnelTask\",\"taskID\":\"90000\",\"pipelineId\":\"2\"},\"metric\":\"SourceReceivedBytes#fake.public.table2\",\"value\":390,\"timestamp\":1724312895572}]}";
        JsonNode jobMetricsStr = new ObjectMapper().readTree(text);
        List<String> metricNameList =
                StreamSupport.stream(
                                Spliterators.spliteratorUnknownSize(jobMetricsStr.fieldNames(), 0),
                                false)
                        .collect(Collectors.toList());

        Map<String, Long> totalCount =
                metricNameList.stream()
                        .filter(metrics -> !metrics.contains("#"))
                        .collect(
                                Collectors.toMap(
                                        metrics -> metrics,
                                        metrics ->
                                                StreamSupport.stream(
                                                                jobMetricsStr
                                                                        .get(metrics)
                                                                        .spliterator(),
                                                                false)
                                                        .mapToLong(
                                                                value ->
                                                                        value.get("value").asLong())
                                                        .sum()));

        Map<String, Long> tableCount =
                metricNameList.stream()
                        .filter(metrics -> metrics.contains("#"))
                        .collect(
                                Collectors.toMap(
                                        metrics -> metrics,
                                        metrics ->
                                                StreamSupport.stream(
                                                                jobMetricsStr
                                                                        .get(metrics)
                                                                        .spliterator(),
                                                                false)
                                                        .mapToLong(
                                                                value ->
                                                                        value.get("value").asLong())
                                                        .sum()));
        System.out.println();
    }
}
